server {
    listen 80;
    listen [::]:80;

    server_name 175.202.33.6;
    charset utf-8;

    return 301  https://$host$request_uri;
}

server {

    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name 175.202.33.6;

    client_max_body_size 9999m;

    proxy_buffer_size 256k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 512k;


    location /upload/ {

        client_max_body_size 9999m;

        if ($request_method = "OPTIONS") {
            add_header 'Access-Control-Allow-Origin' "$http_origin";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

            return 200;
        }

        if ($request_method = "POST") {
            add_header 'Access-Control-Allow-Origin' "$http_origin";
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
            upload_pass  /stream/upload/;
            upload_max_file_size 0;
            upload_max_output_body_len 0;
            upload_store /var/www/images/_upload/ 1;
            upload_store_access user:rw group:rw all:rw;

            set $upload_field_name "uploaded_file";

            upload_set_form_field $upload_field_name.name "$upload_file_name";
            upload_set_form_field $upload_field_name.path "$upload_tmp_path";

            upload_aggregate_form_field "$upload_field_name.size" "$upload_file_size";

            upload_pass_form_field "^submit$|^description$";
            upload_pass_form_field "^name$";
            upload_pass_form_field "dicom_dir";
            upload_pass_form_field "totalCount";
            upload_pass_form_field "files";
            upload_pass_form_field "conditionText";
            upload_pass_form_field "generatetype";
            upload_pass_form_field "institution";
            upload_pass_form_field "multicenter";

            # ** Anonymization Value
            upload_pass_form_field "anonymization";
            # ************************
            upload_pass_form_field "email";
            upload_pass_form_field "^terminal$";
            upload_cleanup 400-599;


        }
    }

    location /stream/upload/ {

        client_max_body_size 9999m;

        # **********************************
        # optimization
        # **********************************

        # proxy_buffering                 off;
        # proxy_request_buffering         off;

        # **********************************
        # 504 error
        # **********************************

        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        send_timeout 300;

        include conf/proxy.conf;

        proxy_pass http://upload_app;
        proxy_redirect off;

    }

    location /stream/download {
        client_max_body_size 9999m;

        if ($request_method = "OPTIONS") {
            add_header 'Access-Control-Allow-Origin' "$http_origin";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

            return 204;
        }

        include conf/proxy.conf;

        proxy_connect_timeout 9999;
        proxy_send_timeout 9999;
        proxy_read_timeout 9999;
        send_timeout 9999;

        proxy_pass http://app;
        proxy_redirect     off;

    }

    location / {
        client_max_body_size 9999m;

        if ($request_method = "OPTIONS") {
            add_header 'Access-Control-Allow-Origin' "$http_origin";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';

            add_header 'Access-Control-Allow-Headers' 'Authorization,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

            return 204;
        }


        include conf/proxy.conf;

        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 300;

        proxy_pass http://app;
        proxy_redirect     off;

    }

    location /static {
        autoindex on;
        alias /var/www/app/static/;
    }

    location /media {
    #   internal; # 외부에서 접근하지 못하도록 internal 설정
        add_header 'Access-Control-Allow-Origin' '*' always;
        autoindex on;
        alias /var/www/app/media/;
    }

    location /protected/ {
        internal;
        alias /var/www/app/static/download/;
    }
}
